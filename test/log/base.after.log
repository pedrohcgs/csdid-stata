-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /home/mauricio/Documents/projects/dev/collab/santanna/csdid-stata/
> base.log
  log type:  text
 opened on:  17 Oct 2025, 18:15:40

. 
. version 14.2

. local root `c(pwd)'

. cd codes
/home/mauricio/Documents/projects/dev/collab/santanna/csdid-stata/codes

. do `root'/test/common.do

. cap mata mata drop _loadmat()

. mata:
------------------------------------------------- mata (type end to exit) -----
: real matrix function _loadmat(string scalar fname) {
>     real vector mat
>     real scalar fh, nr, nc
>     colvector C
>     fh  = fopen(fname, "r")
>     C   = bufio()
>     nr  = fbufget(C, fh, "%4bu", 1)
>     nc  = fbufget(C, fh, "%4bu", 1)
>     mat = fbufget(C, fh, "%8z", nr * nc)
>     fclose(fh)
>     return(rowshape(mat, nc)')
> }

: end
-------------------------------------------------------------------------------

. 
end of do-file

. 
. local methods drimp dripw reg stdipw

. local aggtyps simple group calendar dynamic

. use `root'/tmp/base.dta, clear

. 
.     foreach m of local methods {
  2.         tempfile `m'
  3.     }

.     foreach m of local methods {
  2.         disp "`m'"
  3.         qui csdid Y X, gvar(G) time(period) method(`m') id(id)
  4.         qui estimates save "``m''.ster", replace
  5.     }
drimp
dripw
reg
stdipw

. 
.     foreach m of local methods {
  2.         mata: `m' = _loadmat("`root'/tmp/tmpbase_`m'")
  3.         foreach typ of local aggtyps {
  4.             mata: `m'`typ' = _loadmat("`root'/tmp/tmpbase_`m'_`typ'")
  5.         }
  6.     }

. 
.     foreach m of local methods {
  2.         estimates use "``m''.ster"
  3.         qui csdid
  4.         mata out    = st_matrix("r(table)")[1::2,1..rows(`m')]'
  5.         mata errors = colmax(abs(reldif(`m', out)))
  6.         mata printf("\n%17s: %9.6g\t%9.6g\n", "`m'", errors[1], errors[2])
  7.         foreach typ of local aggtyps {
  8.             if "`typ'" == "dynamic" {
  9.                 qui csdid_estat event
 10.                 mata row = st_matrix("r(table)")[1::2,.]'
 11.                 mata row = row[2::rows(row),.]
 12.             }
 13.             else {
 14.                 qui csdid_estat `typ'
 15.                 mata row = st_matrix("r(table)")[1::2,.]'
 16.             }
 17.             mata errors = colmax(abs(reldif(`m'`typ', row)))
 18.             mata printf("%17s: %9.6g\t%9.6g\n", "`typ' `m'", errors[1], er
> rors[2])
 19.         }
 20.     }

            drimp:  .0000205     .0000559
     simple drimp:  2.23e-06     6.22e-06
      group drimp:  8.46e-06     .0000339
   calendar drimp:  3.50e-06     .0000167
    dynamic drimp:  .0000126     .0000559

            dripw:  1.03e-15     1.50e-11
     simple dripw:         0     6.48e-12
      group dripw:  4.65e-16     2.34e-08
   calendar dripw:  3.25e-16     1.48e-11
    dynamic dripw:  7.25e-16     1.50e-11

              reg:  3.30e-15     1.46e-16
       simple reg:  5.61e-17            0
        group reg:  2.91e-15     1.57e-08
     calendar reg:  2.29e-15     1.29e-17
      dynamic reg:  2.66e-15     2.50e-17

           stdipw:  .0044097      .116297
    simple stdipw:  .0004803     .0444609
     group stdipw:   .002472      .116297
  calendar stdipw:  .0012419     .0776941
   dynamic stdipw:  .0044097     .0726368

. 
end of do-file
